<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idea Heist - 3-Step Viral Pattern System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            padding: 30px 0;
        }
        
        .header h1 {
            font-size: 42px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 18px;
            opacity: 0.95;
        }
        
        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 20px;
        }
        
        .step {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: 600;
            color: #718096;
            transition: all 0.3s;
        }
        
        .step.active {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            transform: scale(1.05);
        }
        
        .step.completed {
            background: #48bb78;
            color: white;
        }
        
        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .step.active .step-number,
        .step.completed .step-number {
            background: rgba(255,255,255,0.3);
        }
        
        /* Screen Management */
        .screen {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .screen.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Step 1: Outlier Selection */
        .filters {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .filter-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #555;
        }
        
        .filter-group select, .filter-group button {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-group button {
            background: #667eea;
            color: white;
            border: none;
            font-weight: 600;
        }
        
        .filter-group button:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .outliers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .outlier-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .outlier-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }
        
        .outlier-card.selected {
            border: 3px solid #48bb78;
        }
        
        .thumbnail-container {
            position: relative;
            padding-top: 56.25%;
            background: #f0f0f0;
        }
        
        .thumbnail {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .score-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .score-badge.fire {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .outlier-info {
            padding: 15px;
        }
        
        .outlier-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.3;
            color: #2d3748;
        }
        
        .outlier-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #718096;
        }
        
        /* Step 2: Pattern Analysis */
        .analysis-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .source-video-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            color: white;
        }
        
        .source-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            opacity: 0.9;
        }
        
        .source-content {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        
        .source-thumbnail {
            width: 160px;
            height: 90px;
            flex-shrink: 0;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(255,255,255,0.1);
        }
        
        .source-thumbnail img {
            width: 100%;
            height: 100%;
            border-radius: 6px;
        }
        
        .source-details {
            flex: 1;
            min-width: 0;
        }
        
        .source-title {
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin-bottom: 12px;
            line-height: 1.3;
        }
        
        .source-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.15);
            padding: 8px 12px;
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }
        
        .stat-label {
            font-size: 11px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        
        .stat-value {
            font-size: 14px;
            font-weight: 600;
        }
        
        .performance-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 8px;
        }
        
        .mega-viral { background: rgba(72, 187, 120, 0.3); }
        .viral { background: rgba(237, 137, 54, 0.3); }
        .good { background: rgba(66, 153, 225, 0.3); }
        
        .pattern-extraction {
            margin-bottom: 30px;
        }
        
        .pattern-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .pattern-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .pattern-name {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
        }
        
        .pattern-details {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .pattern-detail-item {
            margin-bottom: 15px;
        }
        
        .pattern-label {
            font-size: 12px;
            text-transform: uppercase;
            color: #718096;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .pattern-value {
            font-size: 16px;
            color: #2d3748;
            line-height: 1.5;
        }
        
        .validation-section {
            margin-top: 30px;
        }
        
        .validation-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #2d3748;
        }
        
        .validation-strength {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f0fff4;
            border-radius: 8px;
            border: 2px solid #48bb78;
        }
        
        .strength-indicator {
            font-size: 18px;
            font-weight: 700;
        }
        
        .strength-indicator.strong { color: #22543d; }
        .strength-indicator.moderate { color: #d69e2e; }
        .strength-indicator.weak { color: #e53e3e; }
        
        .validation-grid {
            display: grid;
            gap: 15px;
        }
        
        .validation-niche {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .validation-niche:hover {
            border-color: #667eea;
        }
        
        .niche-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .niche-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 16px;
        }
        
        .niche-score {
            background: #48bb78;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .validation-videos {
            font-size: 13px;
            color: #4a5568;
            line-height: 1.6;
        }
        
        .validation-video {
            margin-bottom: 5px;
            padding-left: 15px;
            position: relative;
        }
        
        .validation-video::before {
            content: "→";
            position: absolute;
            left: 0;
            color: #cbd5e0;
        }
        
        /* Step 3: Apply to Channel */
        .apply-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .niche-input-section {
            margin-bottom: 30px;
        }
        
        .niche-input-label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #4a5568;
            font-size: 16px;
        }
        
        .niche-input {
            width: 100%;
            max-width: 400px;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .topics-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .topic-card {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .topic-card:hover {
            border-color: #667eea;
            background: white;
        }
        
        .topic-card.selected {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .topic-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        
        .topic-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            flex: 1;
        }
        
        .topic-difficulty {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .difficulty-easy {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .difficulty-medium {
            background: #fed7aa;
            color: #7c2d12;
        }
        
        .difficulty-hard {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .topic-angle {
            color: #4a5568;
            font-size: 14px;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .topic-performance {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #718096;
        }
        
        .performance-bar {
            flex: 1;
            max-width: 150px;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .performance-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Expanded Topic Section */
        .expanded-content {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e2e8f0;
        }
        
        .content-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 15px;
        }
        
        .titles-list {
            display: grid;
            gap: 10px;
        }
        
        .title-option {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .title-text {
            font-size: 16px;
            color: #2d3748;
            flex: 1;
        }
        
        .title-meta {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .title-style {
            font-size: 12px;
            color: #718096;
            background: white;
            padding: 4px 8px;
            border-radius: 6px;
        }
        
        .confidence-badge {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
        }
        
        .confidence-high {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .confidence-medium {
            background: #fef5e7;
            color: #7c2d12;
        }
        
        .confidence-low {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .thumbnails-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .thumbnail-option {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
        }
        
        .thumbnail-text {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }
        
        .thumbnail-supporting {
            font-size: 14px;
            color: #718096;
            margin-bottom: 10px;
        }
        
        .thumbnail-details {
            font-size: 12px;
            color: #a0aec0;
            line-height: 1.5;
        }
        
        .hooks-list {
            display: grid;
            gap: 10px;
        }
        
        .hook-option {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
        }
        
        .hook-text {
            font-size: 15px;
            color: #2d3748;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .hook-duration {
            font-size: 12px;
            color: #718096;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }
        
        .copy-btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .copy-btn:hover {
            background: #2d3748;
        }
        
        .copy-btn.copied {
            background: #48bb78;
        }
        
        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        /* Validation Display Styles */
        .validation-niches {
            margin-top: 20px;
        }
        
        .validation-niche-section {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .validation-niche-section:hover {
            border-color: #cbd5e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .niche-header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8f9fa;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }
        
        .niche-header-bar:hover {
            background: #e9ecef;
        }
        
        .niche-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .niche-expand-icon {
            font-size: 12px;
            color: #666;
            transition: transform 0.2s;
            width: 12px;
            text-align: center;
        }
        
        .validation-niche-section.expanded .niche-expand-icon {
            transform: rotate(90deg);
        }
        
        .niche-name {
            font-weight: 600;
            color: #2d3748;
        }
        
        .niche-count {
            color: #718096;
            font-size: 14px;
        }
        
        .niche-avg-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        
        .niche-content {
            padding: 16px;
            border-top: 1px solid #e2e8f0;
            background: white;
        }
        
        .validation-video-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
            align-items: flex-start;
        }
        
        .validation-video-item:last-child {
            border-bottom: none;
        }
        
        .video-thumbnail-wrapper {
            position: relative;
            flex-shrink: 0;
        }
        
        .video-thumbnail-small {
            width: 120px;
            height: 68px;
            object-fit: cover;
            border-radius: 6px;
            background: #f1f5f9;
        }
        
        .video-score-overlay {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .video-details {
            flex: 1;
            min-width: 0;
        }
        
        .video-title-small {
            font-weight: 500;
            color: #2d3748;
            line-height: 1.3;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .video-meta-small {
            font-size: 13px;
            color: #718096;
            margin-bottom: 8px;
        }
        
        .source-badge {
            background: #e2e8f0;
            color: #4a5568;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 11px;
        }
        
        .validation-reason {
            background: #f0fff4;
            border: 1px solid #c6f6d5;
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 13px;
            color: #22543d;
            line-height: 1.4;
        }
        
        /* Remove the CSS-generated check mark since it's already in the text */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 Idea Heist</h1>
            <p>Find proven patterns → Validate across niches → Apply to your channel</p>
        </div>
        
        <!-- Progress Indicator -->
        <div class="progress-steps">
            <div class="step active" id="step-1">
                <span class="step-number">1</span>
                <span>Find Outlier</span>
            </div>
            <div class="step" id="step-2">
                <span class="step-number">2</span>
                <span>Analyze Pattern</span>
            </div>
            <div class="step" id="step-3">
                <span class="step-number">3</span>
                <span>Apply to Channel</span>
            </div>
        </div>
        
        <!-- Step 1: Find Outlier -->
        <div id="screen-1" class="screen active">
            <div class="filters">
                <div class="filter-group" style="display: flex; align-items: center; gap: 15px;">
                    <label>Time Range:</label>
                    <select id="timeRange">
                        <option value="day">Last 24 Hours</option>
                        <option value="week">Last Week</option>
                        <option value="month" selected>Last Month</option>
                    </select>
                    
                    <label style="margin-left: 15px;">Min Score:</label>
                    <select id="minScore">
                        <option value="3" selected>3x (Good)</option>
                        <option value="5">5x (Viral)</option>
                        <option value="10">10x (Mega-viral)</option>
                    </select>
                    
                    <button onclick="refreshOutliers()" style="margin-left: auto; background: #48bb78; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;">🎲 Fresh Content</button>
                </div>
            </div>
            
            <div id="outliers-container">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Scanning for viral patterns...</p>
                </div>
            </div>
        </div>
        
        <!-- Step 2: Analyze Pattern -->
        <div id="screen-2" class="screen">
            <div class="analysis-container">
                <div id="analysis-content">
                    <!-- Will be populated dynamically -->
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="goToStep(1)">← Back</button>
                    <button class="btn btn-primary" onclick="goToStep(3)" id="apply-pattern-btn" disabled>
                        Apply This Pattern →
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Step 3: Apply to Channel -->
        <div id="screen-3" class="screen">
            <div class="apply-container">
                <div class="niche-input-section">
                    <label class="niche-input-label">Your Niche:</label>
                    <input type="text" id="targetNiche" class="niche-input" placeholder="e.g., Woodworking, 3D Printing, Gaming..." value="Woodworking">
                    <button class="btn btn-primary" onclick="generateTopics()" style="margin-left: 10px;">
                        ✨ Generate Topic Ideas
                    </button>
                </div>
                
                <div id="topics-container">
                    <!-- Topics will be populated here -->
                </div>
                
                <div id="expanded-container">
                    <!-- Expanded content will be shown here -->
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="goToStep(2)">← Back to Pattern</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global state
        let selectedVideo = null;
        let analyzedPattern = null;
        let validationData = null;
        let selectedTopic = null;
        let outliers = [];
        let currentPage = 0;
        let isLoading = false;
        let hasMore = true;
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            loadOutliers();
            setupInfiniteScroll();
            setupFilterListeners();
        });
        
        // Step navigation
        function goToStep(step) {
            // Update progress indicators
            document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.remove('active');
                if (i < step - 1) s.classList.add('completed');
                if (i === step - 1) s.classList.add('active');
                if (i > step - 1) s.classList.remove('completed');
            });
            
            // Show correct screen
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`screen-${step}`).classList.add('active');
            
            // Load data for step
            if (step === 2 && selectedVideo) {
                analyzePattern();
            }
        }
        
        // Setup infinite scroll
        function setupInfiniteScroll() {
            const container = document.getElementById('outliers-container');
            
            // Create intersection observer
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !isLoading && hasMore) {
                        loadMoreOutliers();
                    }
                });
            }, {
                root: null,
                rootMargin: '100px',
                threshold: 0.1
            });
            
            // Create and observe sentinel element
            const sentinel = document.createElement('div');
            sentinel.id = 'scroll-sentinel';
            sentinel.style.height = '1px';
            container.parentElement.appendChild(sentinel);
            observer.observe(sentinel);
        }
        
        // Setup filter listeners
        function setupFilterListeners() {
            document.getElementById('timeRange').addEventListener('change', () => {
                currentPage = 0;
                outliers = [];
                hasMore = true;
                loadOutliers(false);
            });
            
            document.getElementById('minScore').addEventListener('change', () => {
                currentPage = 0;
                outliers = [];
                hasMore = true;
                loadOutliers(false);
            });
        }
        
        // Step 1: Load outliers
        async function loadOutliers(append = false) {
            if (isLoading) return;
            isLoading = true;
            
            const container = document.getElementById('outliers-container');
            
            // Show loading state
            if (!append) {
                container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Scanning for viral patterns...</p></div>';
            } else {
                // Add loading indicator at bottom
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loading-more';
                loadingDiv.className = 'loading';
                loadingDiv.innerHTML = '<div class="loading-spinner"></div><p>Loading more...</p>';
                container.appendChild(loadingDiv);
            }
            
            const offset = currentPage * 20;
            
            const params = new URLSearchParams({
                timeRange: document.getElementById('timeRange').value,
                minScore: document.getElementById('minScore').value,
                limit: '20',
                offset: offset.toString(),
                randomize: 'true'  // Always randomize for fresh results
            });
            
            try {
                const response = await fetch(`/api/idea-radar?${params}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load outliers');
                }
                
                // Append or replace outliers
                if (append) {
                    outliers = [...outliers, ...data.outliers];
                    // Remove loading indicator
                    const loadingMore = document.getElementById('loading-more');
                    if (loadingMore) loadingMore.remove();
                } else {
                    outliers = data.outliers;
                }
                
                hasMore = data.hasMore;
                
                displayOutliers(outliers, append);
                
            } catch (error) {
                if (!append) {
                    container.innerHTML = `<div class="error-message">❌ ${error.message}</div>`;
                } else {
                    const loadingMore = document.getElementById('loading-more');
                    if (loadingMore) loadingMore.remove();
                }
            } finally {
                isLoading = false;
            }
        }
        
        // Load more outliers for infinite scroll
        async function loadMoreOutliers() {
            if (!hasMore || isLoading) return;
            currentPage++;
            await loadOutliers(true);
        }
        
        // Fresh content handler - gets new randomized results
        function refreshOutliers() {
            currentPage = 0;
            outliers = [];
            hasMore = true;
            window.scrollTo(0, 0);
            loadOutliers(false);
        }
        
        function displayOutliers(allOutliers, append = false) {
            const container = document.getElementById('outliers-container');
            
            if (!append && (!allOutliers || allOutliers.length === 0)) {
                container.innerHTML = '<div class="error-message">No outliers found. Try adjusting your filters.</div>';
                return;
            }
            
            // Get existing grid or create new one
            let grid = container.querySelector('.outliers-grid');
            if (!grid || !append) {
                grid = document.createElement('div');
                grid.className = 'outliers-grid';
                if (!append) {
                    container.innerHTML = '';
                    container.appendChild(grid);
                }
            }
            
            // Only display new videos when appending
            const videosToDisplay = append ? allOutliers.slice(-20) : allOutliers;
            
            videosToDisplay.forEach(video => {
                const card = document.createElement('div');
                card.className = 'outlier-card';
                card.onclick = () => selectVideo(video);
                
                const scoreClass = video.score >= 10 ? 'fire' : '';
                
                // Calculate days ago
                const daysAgo = video.age_days || 0;
                const dateText = daysAgo === 0 ? 'Today' : 
                               daysAgo === 1 ? 'Yesterday' : 
                               `${daysAgo} days ago`;
                
                card.innerHTML = `
                    <div class="thumbnail-container">
                        <img src="${video.thumbnail_url}" alt="${video.title}" class="thumbnail">
                        <span class="score-badge ${scoreClass}">${video.score.toFixed(1)}x</span>
                    </div>
                    <div class="outlier-info">
                        <div class="outlier-title">${video.title}</div>
                        <div class="outlier-meta">
                            <span>${video.channel_name}</span>
                            <span>${formatViews(video.views)} views</span>
                        </div>
                        <div class="outlier-meta" style="margin-top: 4px;">
                            <span style="color: #a0aec0;">📅 ${dateText}</span>
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
            
            // If appending and we have the grid, append it to container
            if (append && !container.contains(grid)) {
                container.appendChild(grid);
            }
        }
        
        function selectVideo(video) {
            selectedVideo = video;
            document.querySelectorAll('.outlier-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Go to step 2
            goToStep(2);
        }
        
        // Step 2: Analyze pattern
        async function analyzePattern() {
            if (!selectedVideo) return;
            
            const container = document.getElementById('analysis-content');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Analyzing pattern and validating across niches...</p></div>';
            
            try {
                const response = await fetch('/api/analyze-pattern', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ video_id: selectedVideo.video_id })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to analyze pattern');
                }
                
                analyzedPattern = data.pattern;
                validationData = data.validation;
                displayAnalysis(data);
                
                // Enable apply button
                document.getElementById('apply-pattern-btn').disabled = false;
                
            } catch (error) {
                container.innerHTML = `<div class="error-message">❌ ${error.message}</div>`;
            }
        }
        
        function displayAnalysis(data) {
            const container = document.getElementById('analysis-content');
            const { pattern, source_video, validation } = data;
            
            // Use actual temporal baseline from the database
            // Note: channel_baseline_at_publish represents the average of the last 10 videos 
            // published within 30 days before this video (temporal context)
            const channelBaseline = source_video.baseline || Math.round(source_video.views / source_video.score);
            const percentageAbove = ((source_video.score - 1) * 100).toFixed(0);
            const performanceTier = source_video.score >= 10 ? 'mega-viral' : 
                                   source_video.score >= 5 ? 'viral' : 'good';
            const tierLabel = source_video.score >= 10 ? 'MEGA VIRAL' : 
                             source_video.score >= 5 ? 'VIRAL' : 'GOOD PERFORMER';
            const tierIcon = source_video.score >= 10 ? '🔥' : 
                            source_video.score >= 5 ? '🚀' : '📈';
            
            container.innerHTML = `
                <!-- Source Video Dashboard -->
                <div class="source-video-display">
                    <div class="source-header">
                        <span>📊</span>
                        <span>VIRAL VIDEO BREAKDOWN</span>
                    </div>
                    <div class="source-content">
                        <div class="source-thumbnail">
                            <img src="${source_video.thumbnail}" alt="${source_video.title}">
                        </div>
                        <div class="source-details">
                            <div class="source-title">${source_video.title}</div>
                            <div>Channel: ${source_video.channel} (${source_video.niche})</div>
                            
                            <div class="source-stats-grid">
                                <div class="stat-item">
                                    <div class="stat-label">This Video</div>
                                    <div class="stat-value">${formatViews(source_video.views)} views</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Channel Baseline</div>
                                    <div class="stat-value">${formatViews(channelBaseline)} views</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Performance</div>
                                    <div class="stat-value">${source_video.score.toFixed(1)}x (+${percentageAbove}%)</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Published</div>
                                    <div class="stat-value">${getTimeAgo(source_video.published_at || new Date())}</div>
                                </div>
                            </div>
                            
                            <div class="performance-badge ${performanceTier}">
                                <span>${tierIcon}</span>
                                <span>${tierLabel}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Pattern Extraction -->
                <div class="pattern-extraction">
                    <div class="pattern-header">
                        <div class="pattern-icon">🎯</div>
                        <div class="pattern-name">${pattern.pattern_name}</div>
                    </div>
                    
                    <div class="pattern-details">
                        <div class="pattern-detail-item">
                            <div class="pattern-label">Pattern Description</div>
                            <div class="pattern-value">${pattern.pattern_description}</div>
                        </div>
                        <div class="pattern-detail-item">
                            <div class="pattern-label">Psychological Trigger</div>
                            <div class="pattern-value">${pattern.psychological_trigger}</div>
                        </div>
                        <div class="pattern-detail-item">
                            <div class="pattern-label">Why It Works</div>
                            <div class="pattern-value">${pattern.why_it_works}</div>
                        </div>
                        <div class="pattern-detail-item">
                            <div class="pattern-label">Key Elements</div>
                            <div class="pattern-value">${pattern.key_elements.join(' • ')}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Validation Section -->
                <div class="validation-section">
                    <div class="validation-header">📊 Cross-Niche Validation</div>
                    
                    <div class="validation-strength">
                        <span>Pattern Strength:</span>
                        <span class="strength-indicator ${validation.pattern_strength}">
                            ${validation.pattern_strength.toUpperCase()}
                        </span>
                        <span>${validation.total_validations} similar videos found</span>
                        <span>Average: ${validation.avg_pattern_score.toFixed(1)}x performance</span>
                    </div>
                    
                    <div class="validation-niches">
                        ${validation.results.slice(0, 6).map((niche, index) => `
                            <div class="validation-niche-section ${index === 0 ? 'expanded' : ''}">
                                <div class="niche-header-bar" onclick="toggleNiche(this)">
                                    <div class="niche-header-left">
                                        <span class="niche-expand-icon">${index === 0 ? '▼' : '▶'}</span>
                                        <span class="niche-name">${niche.niche}</span>
                                        <span class="niche-count">(${niche.count} videos)</span>
                                    </div>
                                    <div class="niche-avg-badge" style="background: ${niche.avg_score >= 10 ? '#48bb78' : niche.avg_score >= 5 ? '#ed8936' : '#4299e1'};">
                                        ${niche.avg_score.toFixed(1)}x avg
                                    </div>
                                </div>
                                <div class="niche-content" style="${index === 0 ? '' : 'display: none;'}">
                                    ${niche.videos.slice(0, 3).map(v => `
                                        <div class="validation-video-item">
                                            <div class="video-thumbnail-wrapper">
                                                <img src="${v.thumbnail_url}" alt="${v.title}" class="video-thumbnail-small">
                                                <span class="video-score-overlay">${v.score.toFixed(1)}x</span>
                                            </div>
                                            <div class="video-details">
                                                <div class="video-title-small">${v.title}</div>
                                                <div class="video-meta-small">
                                                    <span>${v.channel}</span> • 
                                                    <span>${formatViews(v.views)} views</span>
                                                    ${v.source ? `• <span class="source-badge">Found via ${v.source}</span>` : ''}
                                                </div>
                                                ${v.validation_reason ? `
                                                    <div class="validation-reason">
                                                        <span class="reason-icon">✓</span>
                                                        <span class="reason-text">${v.validation_reason}</span>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Step 3: Generate topics
        async function generateTopics() {
            if (!analyzedPattern || !validationData) {
                alert('Please analyze a pattern first');
                return;
            }
            
            const targetNiche = document.getElementById('targetNiche').value;
            if (!targetNiche) {
                alert('Please enter your target niche');
                return;
            }
            
            const container = document.getElementById('topics-container');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Generating topic ideas...</p></div>';
            
            // Clear expanded content
            document.getElementById('expanded-container').innerHTML = '';
            
            // Prepare validation examples
            const validationExamples = validationData.results.slice(0, 3).map(r => ({
                niche: r.niche,
                avg_score: r.avg_score,
                example_titles: r.videos.map(v => v.title)
            }));
            
            try {
                const response = await fetch('/api/generate-topics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pattern: analyzedPattern,
                        source_video: {
                            title: selectedVideo.title,
                            niche: selectedVideo.domain || selectedVideo.niche
                        },
                        target_niche: targetNiche,
                        validation_examples: validationExamples
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to generate topics');
                }
                
                displayTopics(data.topics);
                
            } catch (error) {
                container.innerHTML = `<div class="error-message">❌ ${error.message}</div>`;
            }
        }
        
        function displayTopics(topics) {
            const container = document.getElementById('topics-container');
            
            const grid = document.createElement('div');
            grid.className = 'topics-grid';
            
            topics.forEach(topic => {
                const card = document.createElement('div');
                card.className = 'topic-card';
                card.onclick = () => expandTopic(topic);
                
                const performancePercent = topic.estimated_performance * 10;
                
                card.innerHTML = `
                    <div class="topic-header">
                        <div class="topic-title">${topic.topic}</div>
                        <span class="topic-difficulty difficulty-${topic.difficulty}">${topic.difficulty}</span>
                    </div>
                    <div class="topic-angle">${topic.angle}</div>
                    <div class="topic-performance">
                        <span>Estimated Performance:</span>
                        <div class="performance-bar">
                            <div class="performance-fill" style="width: ${performancePercent}%"></div>
                        </div>
                        <span>${topic.estimated_performance}/10</span>
                    </div>
                `;
                
                grid.appendChild(card);
            });
            
            container.innerHTML = '<h3 style="margin-bottom: 20px;">📝 Topic Ideas for Your Channel:</h3>';
            container.appendChild(grid);
        }
        
        // Expand topic for titles and thumbnails
        async function expandTopic(topic) {
            selectedTopic = topic;
            
            // Update UI
            document.querySelectorAll('.topic-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            const container = document.getElementById('expanded-container');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Generating titles and thumbnails...</p></div>';
            
            try {
                const response = await fetch('/api/expand-topic', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: topic,
                        pattern: {
                            pattern_name: analyzedPattern.pattern_name,
                            psychological_trigger: analyzedPattern.psychological_trigger
                        },
                        target_niche: document.getElementById('targetNiche').value
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to expand topic');
                }
                
                displayExpandedContent(data.expanded);
                
            } catch (error) {
                container.innerHTML = `<div class="error-message">❌ ${error.message}</div>`;
            }
        }
        
        function displayExpandedContent(expanded) {
            const container = document.getElementById('expanded-container');
            
            container.innerHTML = `
                <div class="expanded-content">
                    <!-- Titles -->
                    <div class="content-section">
                        <div class="section-title">📝 Title Options</div>
                        <div class="titles-list">
                            ${expanded.titles.map(title => {
                                const confidenceClass = title.confidence >= 0.8 ? 'high' : 
                                                       title.confidence >= 0.5 ? 'medium' : 'low';
                                const confidenceText = title.confidence >= 0.8 ? 'High' : 
                                                      title.confidence >= 0.5 ? 'Medium' : 'Low';
                                return `
                                    <div class="title-option">
                                        <div class="title-text">${title.title}</div>
                                        <div class="title-meta">
                                            <span class="title-style">${title.style}</span>
                                            <span class="confidence-badge confidence-${confidenceClass}">
                                                ${confidenceText} (${Math.round(title.confidence * 100)}%)
                                            </span>
                                            <button class="copy-btn" onclick="copyText('${title.title.replace(/'/g, "\\'")}', this)">
                                                📋 Copy
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Thumbnails -->
                    <div class="content-section">
                        <div class="section-title">🎨 Thumbnail Text Options</div>
                        <div class="thumbnails-grid">
                            ${expanded.thumbnails.map(thumb => `
                                <div class="thumbnail-option">
                                    <div class="thumbnail-text">${thumb.main_text}</div>
                                    ${thumb.supporting_text ? `<div class="thumbnail-supporting">${thumb.supporting_text}</div>` : ''}
                                    <div class="thumbnail-details">
                                        <strong>Visual:</strong> ${thumb.visual_elements.join(', ')}<br>
                                        <strong>Emotion:</strong> ${thumb.emotion}<br>
                                        <strong>Colors:</strong> ${thumb.color_scheme}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Hooks -->
                    <div class="content-section">
                        <div class="section-title">🎬 Opening Hooks</div>
                        <div class="hooks-list">
                            ${expanded.hooks.map(hook => `
                                <div class="hook-option">
                                    <div class="hook-text">"${hook.hook}"</div>
                                    <div class="hook-duration">Duration: ${hook.duration}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Utility functions
        function formatViews(views) {
            if (views >= 1000000) {
                return (views / 1000000).toFixed(1) + 'M';
            } else if (views >= 1000) {
                return (views / 1000).toFixed(1) + 'K';
            }
            return views.toLocaleString();
        }
        
        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
            const diffInDays = Math.floor(diffInHours / 24);
            
            if (diffInDays === 0) {
                return 'Today';
            } else if (diffInDays === 1) {
                return 'Yesterday';
            } else if (diffInDays < 30) {
                return `${diffInDays} days ago`;
            } else {
                const diffInMonths = Math.floor(diffInDays / 30);
                return `${diffInMonths} month${diffInMonths === 1 ? '' : 's'} ago`;
            }
        }
        
        function copyText(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = '✓ Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = '📋 Copy';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }
        
        // Toggle niche section expand/collapse
        function toggleNiche(headerElement) {
            const section = headerElement.parentElement;
            const content = section.querySelector('.niche-content');
            const icon = section.querySelector('.niche-expand-icon');
            
            const isExpanded = section.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                section.classList.remove('expanded');
                content.style.display = 'none';
                icon.textContent = '▶';
            } else {
                // Expand
                section.classList.add('expanded');
                content.style.display = 'block';
                icon.textContent = '▼';
            }
        }
    </script>
</body>
</html>